#!/bin/bash -e
#
# Create a LXD with the specified name (and optionally ubuntu release) and
# bind-mount current user's home directory.


SCRIPTNAME=$(basename "$0")

DEFAULT_IMAGE="bionic"
LXD_PROFILE="home-bind"
CLOUD_INIT_CONF="#cloud-config
groups:
  - $USER
users:
  - name: $USER
    primary-group: $USER
    groups: [libvirtd, kvm]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    no-create-home: true
"


ensure_profile() {
    if lxc profile show "$LXD_PROFILE" >/dev/null 2>&1; then
        return
    fi

    cat <<EOF | lxc profile create "$LXD_PROFILE"
name: $LXD_PROFILE
description: Bind-mount home
devices:
  homedir:
    path: /home
    source: /home
    type: disk
EOF
}

set_subuids() {
    local subid_line="root:$UID:1"
    local file
    for file in /etc/subuid /etc/subgid; do
        if ! grep -q "$subid_line" "$file"; then
            echo "$subid_line" | sudo tee -a "$file"
        fi
    done
}

create_container() {
    local container="$1"
    local release="$2"

    lxc init "$release" "$container"
    lxc config set "$container" raw.idmap "both 1000 1000"
    lxc config set "$container" user.user-data "$CLOUD_INIT_CONF"
    lxc profile add "$container" "$LXD_PROFILE"
    lxc start "$container"
}


container="$1"
release="${2:-$DEFAULT_IMAGE}"

if [ -z "$container" ]; then
    echo "Usage:  $SCRIPTNAME <container-name> [ubuntu-release]"
    exit 1
fi

ensure_profile
set_subuids
create_container "$container" "$release"
