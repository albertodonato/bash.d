#!/bin/bash -e
#
# Create a LXD with the specified name (and optionally ubuntu release) and
# bind-mount current user's home directory.


SCRIPTNAME=$(basename "$0")

DEFAULT_IMAGE="bionic"
LXD_PROFILE="home-bind"

ensure_profile() {
    if ! lxc profile show "$LXD_PROFILE" >/dev/null 2>&1; then
        lxc profile create "$LXD_PROFILE"
    fi

    local uid
    uid=$(id -u "$USER")

    # ensure it's up to date
    cat <<EOF | lxc profile edit "$LXD_PROFILE"
name: $LXD_PROFILE
description: Bind-mount home
config:
  raw.idmap: both 1000 1000
  user.user-data: |
    #cloud-config
    groups:
      - $USER
    users:
      - name: $USER
        primary-group: $USER
        groups: [libvirtd, kvm]
        shell: /bin/bash
        sudo: ALL=(ALL) NOPASSWD:ALL
        no-create-home: true
devices:
  homedir:
    path: /home
    source: /home
    type: disk
EOF
}

set_subuids() {
    local subid_line="root:$UID:1"
    local file
    for file in /etc/subuid /etc/subgid; do
        if ! grep -q "$subid_line" "$file"; then
            echo "$subid_line" | sudo tee -a "$file"
        fi
    done
}

create_container() {
    local container="$1"
    local release="$2"
    lxc launch "$release" "$container" -p default -p "$LXD_PROFILE"
}


container="$1"
release="${2:-$DEFAULT_IMAGE}"

if [ -z "$container" ]; then
    echo "Usage:  $SCRIPTNAME <container-name> [ubuntu-release]"
    exit 1
fi

ensure_profile
set_subuids
create_container "$container" "$release"
