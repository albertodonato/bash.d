#!/bin/bash -e
#
# Create a LXD with the specified name (and optionally ubuntu release) and
# bind-mount current user's home directory.


SCRIPTNAME=$(basename "$0")
PROFILE="home-bind"

ensure_profile() {
    if lxc profile show "$PROFILE" >/dev/null 2>&1; then
        return
    fi

    cat <<EOF | lxc profile create "$PROFILE"
name: $PROFILE
description: Bind-mount home
devices:
  homedir:
    path: /home
    source: /home
    type: disk
EOF
}

set_subuids() {
    local subid_line="root:$UID:1"
    local file
    for file in /etc/subuid /etc/subgid; do
        if ! grep -q "$subid_line" "$file"; then
            echo "$subid_line" | sudo tee -a "$file"
        fi
    done
}


container="$1"
release="${2:-xenial}"

if [ -z "$container" ]; then
    echo "Usage:  $SCRIPTNAME <container-name> [ubuntu-release]"
    exit 1
fi

ensure_profile
set_subuids


lxc init "$release" "$container"
lxc config set "$container" raw.idmap "both 1000 1000"
lxc config set "$container" boot.autostart	1
lxc profile add "$container" "$PROFILE"
lxc start "$container"
sleep 10
lxc exec --verbose "$container" -- \
    sed -i "s/^ubuntu:/$USER:/g; s,/home/ubuntu,$HOME,g" \
    /etc/passwd /etc/shadow /etc/group /etc/gshadow
lxc exec "$container" -- sed -i "s/ubuntu/$USER/g" \
        /etc/sudoers.d/90-cloud-init-users
